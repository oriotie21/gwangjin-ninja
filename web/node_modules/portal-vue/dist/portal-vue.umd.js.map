{"version":3,"file":"portal-vue.umd.js","sources":["../src/composables/wormhole.ts","../src/utils/index.ts","../src/components/portal.ts","../src/components/portal-target.ts","../src/wormhole.ts","../src/utils/mountPortalTarget.ts","../src/index.ts"],"sourcesContent":["import { type InjectionKey, inject, provide } from 'vue'\nimport type { Wormhole } from '../types'\n\nexport const wormholeSymbol = Symbol('wormhole') as InjectionKey<Wormhole>\n\nexport function useWormhole() {\n  const wh = inject(wormholeSymbol)\n\n  if (!wh) {\n    throw new Error(`\n    [portal-vue]: Necessary Injection not found. Make sur you installed the plugin properly.`)\n  }\n\n  return wh\n}\n\nexport function provideWormhole(wormhole: Wormhole) {\n  provide(wormholeSymbol, wormhole)\n}\n","import { watch } from 'vue'\n\nexport const inBrowser = typeof window !== 'undefined'\n\nexport const __DEV__ = __NODE_ENV__ === 'development'\n\nexport function warn(msg: string) {\n  console.log('[portal-vue]: ' + msg)\n}\n\nexport function assertStaticProps(\n  component: string,\n  props: Record<string, any>,\n  propNames: string[]\n) {\n  propNames.forEach(\n    (name) => {\n      watch(\n        () => props[name],\n        () => {\n          warn(\n            `Prop '${name}' of component ${component} is static, but was dynamically changed by the parent.\n          This change will not have any effect.`\n          )\n        }\n      )\n    },\n    { flush: 'post' }\n  )\n}\n\nexport function stableSort<T>(array: T[], compareFn: Function) {\n  return array\n    .map((v: T, idx: number) => {\n      return [idx, v] as [number, T]\n    })\n    .sort(function (a, b) {\n      return compareFn(a[1], b[1]) || a[0] - b[0]\n    })\n    .map((c) => c[1])\n}\n","import {\n  type Slots,\n  defineComponent,\n  onBeforeUnmount,\n  onMounted,\n  onUpdated,\n  watch,\n} from 'vue'\nimport { useWormhole } from '../composables/wormhole'\nimport type { Name, PortalProps } from '../types'\nimport { __DEV__, assertStaticProps, inBrowser } from '../utils'\n\nexport function usePortal(props: PortalProps, slots: Slots) {\n  const wormhole = useWormhole()\n\n  function sendUpdate() {\n    if (!inBrowser) return\n    const { to, name: from, order } = props\n    if (slots.default) {\n      wormhole.open({\n        to,\n        from: from!,\n        order,\n        content: slots.default,\n      })\n    } else {\n      clear()\n    }\n  }\n\n  function clear(target?: Name) {\n    wormhole.close({\n      to: target ?? props.to,\n      from: props.name,\n    })\n  }\n  onMounted(() => {\n    if (!props.disabled) {\n      sendUpdate()\n    }\n  })\n\n  onUpdated(() => {\n    if (props.disabled) {\n      clear()\n    } else {\n      sendUpdate()\n    }\n  })\n\n  onBeforeUnmount(() => {\n    clear()\n  })\n\n  watch(\n    () => props.to,\n    (newTo, oldTo) => {\n      if (props.disabled) return\n      if (oldTo && oldTo !== newTo) {\n        clear(oldTo)\n      }\n      sendUpdate()\n    }\n  )\n}\n\nexport default defineComponent({\n  compatConfig: { MODE: 3 },\n  name: 'portal',\n  props: {\n    disabled: { type: Boolean },\n    name: { type: [String, Symbol], default: () => Symbol() },\n    order: { type: Number },\n    slotProps: { type: Object, default: () => ({}) },\n    to: {\n      type: String,\n      default: () => String(Math.round(Math.random() * 10000000)),\n    },\n  },\n  setup(props, { slots }) {\n    __DEV__ && assertStaticProps('Portal', props, ['order', 'name'])\n    usePortal(props, slots)\n\n    return () => {\n      if (props.disabled && slots.default) {\n        return slots.default(props.slotProps)\n      } else {\n        return null\n      }\n    }\n  },\n})\n","import {\n  type FunctionalComponent,\n  type VNode,\n  computed,\n  defineComponent,\n  h,\n  watch,\n} from 'vue'\nimport { useWormhole } from '../composables/wormhole'\n\nconst PortalTargetContent: FunctionalComponent = (_, { slots }) => {\n  return slots.default?.()\n}\n\nexport default defineComponent({\n  compatConfig: { MODE: 3 },\n  name: 'portalTarget',\n  props: {\n    multiple: { type: Boolean, default: false },\n    name: { type: String, required: true },\n    slotProps: { type: Object, default: () => ({}) },\n  },\n  emits: ['change'],\n  setup(props, { emit, slots }) {\n    const wormhole = useWormhole()\n\n    const slotVnodes = computed<{ vnodes: VNode[]; vnodesFn: () => VNode[] }>(\n      () => {\n        const transports = wormhole.getContentForTarget(\n          props.name,\n          props.multiple\n        )\n        const wrapperSlot = slots.wrapper\n        const rawNodes = transports.map((t) => t.content(props.slotProps))\n        const vnodes = wrapperSlot\n          ? rawNodes.flatMap((nodes) =>\n              nodes.length ? wrapperSlot(nodes) : []\n            )\n          : rawNodes.flat(1)\n        return {\n          vnodes,\n          vnodesFn: () => vnodes, // just to make Vue happy. raw vnodes in a slot give a DEV warning\n        }\n      }\n    )\n\n    watch(\n      slotVnodes,\n      ({ vnodes }) => {\n        const hasContent = vnodes.length > 0\n        const content = wormhole.transports.get(props.name)\n        const sources = content ? [...content.keys()] : []\n        emit('change', { hasContent, sources })\n      },\n      { flush: 'post' }\n    )\n    return () => {\n      const hasContent = !!slotVnodes.value.vnodes.length\n      if (hasContent) {\n        return [\n          // this node is a necessary hack to force Vue to change the scoped-styles boundary\n          // TODO:  find less hacky solution\n          h('div', {\n            style: 'display: none',\n            key: '__portal-vue-hacky-scoped-slot-repair__',\n          }),\n          // we wrap the slot content in a functional component\n          // so that transitions in the slot can properly determine first render\n          // for `appear` behavior to work properly\n          h(PortalTargetContent, slotVnodes.value.vnodesFn),\n        ]\n      } else {\n        return slots.default?.()\n      }\n    }\n  },\n})\n","import { reactive, readonly } from 'vue'\nimport type {\n  Name,\n  Transport,\n  TransportCloser,\n  TransportInput,\n  TransportsHub,\n  Wormhole,\n} from './types'\nimport { inBrowser, stableSort } from './utils'\n\nexport function createWormhole(asReadonly = true): Wormhole {\n  const transports: TransportsHub = reactive(new Map())\n\n  function open(transport: TransportInput) {\n    if (!inBrowser) return\n\n    const { to, from, content, order = Infinity } = transport\n    if (!to || !from || !content) return\n\n    if (!transports.has(to)) {\n      transports.set(to, new Map())\n    }\n    const transportsForTarget = transports.get(to)!\n\n    const newTransport = {\n      to,\n      from,\n      content,\n      order,\n    } as Transport\n\n    transportsForTarget.set(from, newTransport)\n  }\n\n  function close(transport: TransportCloser) {\n    const { to, from } = transport\n    if (!to || !from) return\n    const transportsForTarget = transports.get(to)\n    if (!transportsForTarget) {\n      return\n    }\n    transportsForTarget.delete(from)\n    if (!transportsForTarget.size) {\n      transports.delete(to)\n    }\n  }\n\n  function getContentForTarget(target: Name, returnAll?: boolean) {\n    const transportsForTarget = transports.get(target)\n    if (!transportsForTarget) return []\n\n    const content = Array.from(transportsForTarget?.values() || [])\n\n    if (!returnAll) {\n      // return Transport that was added last\n      return [content.pop()] as Transport[]\n    }\n    // return all Transports, sorted by their order property\n    return stableSort(\n      content,\n      (a: Transport, b: Transport) => a.order - b.order\n    )\n  }\n\n  const wh: Wormhole = {\n    open,\n    close,\n    transports,\n    getContentForTarget,\n  }\n  return asReadonly ? (readonly(wh) as Wormhole) : wh\n}\n\nexport const wormhole = createWormhole()\n","import type { PortalTargetProps } from '../types'\nimport {\n  type ComponentInternalInstance,\n  createApp,\n  getCurrentInstance,\n  h,\n  onBeforeUnmount,\n  onMounted,\n} from 'vue'\nimport PortalTarget from '../components/portal-target'\n\nexport function mountPortalTarget(\n  targetProps: PortalTargetProps,\n  el: HTMLElement | string\n) {\n  const app = createApp({\n    // @ts-expect-error no idea why h() doesn't like this import\n    render: () => h(PortalTarget, targetProps),\n  })\n\n  if (!targetProps.multiple) {\n    // this is hacky as it relies on internals, but works.\n    // TODO: can we get rid of this by somehow properly replacing the target's .parent?\n    const provides =\n      (\n        getCurrentInstance() as ComponentInternalInstance & {\n          provides: Record<string, any>\n        }\n      ).provides ?? {}\n    app._context.provides = Object.create(provides)\n    //Object.assign(app._context.provides, Object.create(provides))\n  }\n  onMounted(() => {\n    app.mount(el)\n  })\n  onBeforeUnmount(() => {\n    app.unmount()\n  })\n}\n","import type { App } from 'vue'\nimport Portal from './components/portal'\nimport PortalTarget from './components/portal-target'\nimport {\n  provideWormhole,\n  useWormhole,\n  wormholeSymbol,\n} from './composables/wormhole'\nimport type { Wormhole as TWormhole } from './types'\nimport { createWormhole, wormhole as defaultWormhole } from './wormhole'\nexport { mountPortalTarget } from './utils/mountPortalTarget'\nexport interface PluginOptions {\n  portalName?: string | false\n  portalTargetName?: string | false\n  MountingPortalName?: string\n  wormhole?: TWormhole\n}\n\nexport default function install(app: App, options: PluginOptions = {}) {\n  options.portalName !== false &&\n    app.component(options.portalName || 'Portal', Portal)\n  options.portalTargetName !== false &&\n    app.component(options.portalTargetName || 'PortalTarget', PortalTarget)\n\n  const wormhole = options.wormhole ?? defaultWormhole\n  app.provide(wormholeSymbol, wormhole)\n}\n\nexport const Wormhole = defaultWormhole\n\nexport const version = __PORTAL_VUE_VERSION__\n\nexport {\n  install,\n  Portal,\n  PortalTarget,\n  useWormhole,\n  provideWormhole,\n  TWormhole,\n  createWormhole,\n}\n"],"names":["wormholeSymbol","useWormhole","wh","inject","provideWormhole","wormhole","provide","inBrowser","stableSort","array","compareFn","v","idx","a","b","c","usePortal","props","slots","sendUpdate","to","from","order","clear","target","onMounted","onUpdated","onBeforeUnmount","watch","newTo","oldTo","Portal","defineComponent","PortalTargetContent","_","_a","PortalTarget","emit","slotVnodes","computed","transports","wrapperSlot","rawNodes","t","vnodes","nodes","hasContent","content","sources","h","createWormhole","asReadonly","reactive","open","transport","transportsForTarget","newTransport","close","getContentForTarget","returnAll","readonly","mountPortalTarget","targetProps","el","app","createApp","provides","getCurrentInstance","install","options","defaultWormhole","Wormhole","version"],"mappings":"8PAGa,MAAAA,EAAiB,OAAO,UAAU,EAExC,SAASC,GAAc,CACtB,MAAAC,EAAKC,SAAOH,CAAc,EAEhC,GAAI,CAACE,EACH,MAAM,IAAI,MAAM;AAAA,6FACyE,EAGpF,OAAAA,CACT,CAEO,SAASE,EAAgBC,EAAoB,CAClDC,UAAQN,EAAgBK,CAAQ,CAClC,CChBa,MAAAE,EAAY,OAAO,OAAW,IA6B3B,SAAAC,EAAcC,EAAYC,EAAqB,CAC7D,OAAOD,EACJ,IAAI,CAACE,EAAMC,IACH,CAACA,EAAKD,CAAC,CACf,EACA,KAAK,SAAUE,EAAGC,EAAG,CACb,OAAAJ,EAAUG,EAAE,GAAIC,EAAE,EAAE,GAAKD,EAAE,GAAKC,EAAE,EAAA,CAC1C,EACA,IAAKC,GAAMA,EAAE,EAAE,CACpB,CC5BgB,SAAAC,EAAUC,EAAoBC,EAAc,CAC1D,MAAMb,EAAWJ,IAEjB,SAASkB,GAAa,CACpB,GAAI,CAACZ,EAAW,OAChB,KAAM,CAAE,GAAAa,EAAI,KAAMC,EAAM,MAAAC,GAAUL,EAC9BC,EAAM,QACRb,EAAS,KAAK,CACZ,GAAAe,EACA,KAAAC,EACA,MAAAC,EACA,QAASJ,EAAM,OAAA,CAChB,EAEKK,GAEV,CAEA,SAASA,EAAMC,EAAe,CAC5BnB,EAAS,MAAM,CACb,GAAImB,GAAUP,EAAM,GACpB,KAAMA,EAAM,IAAA,CACb,CACH,CACAQ,EAAAA,UAAU,IAAM,CACTR,EAAM,UACEE,GACb,CACD,EAEDO,EAAAA,UAAU,IAAM,CACVT,EAAM,SACFM,IAEKJ,GACb,CACD,EAEDQ,EAAAA,gBAAgB,IAAM,CACdJ,GAAA,CACP,EAEDK,EAAA,MACE,IAAMX,EAAM,GACZ,CAACY,EAAOC,IAAU,CACZb,EAAM,WACNa,GAASA,IAAUD,GACrBN,EAAMO,CAAK,EAEFX,IACb,CAAA,CAEJ,CAEA,MAAAY,EAAeC,kBAAgB,CAC7B,aAAc,CAAE,KAAM,CAAE,EACxB,KAAM,SACN,MAAO,CACL,SAAU,CAAE,KAAM,OAAQ,EAC1B,KAAM,CAAE,KAAM,CAAC,OAAQ,MAAM,EAAG,QAAS,IAAM,QAAS,EACxD,MAAO,CAAE,KAAM,MAAO,EACtB,UAAW,CAAE,KAAM,OAAQ,QAAS,KAAO,CAAI,EAAA,EAC/C,GAAI,CACF,KAAM,OACN,QAAS,IAAM,OAAO,KAAK,MAAM,KAAK,OAAA,EAAW,GAAQ,CAAC,CAC5D,CACF,EACA,MAAMf,EAAO,CAAE,MAAAC,GAAS,CAEtB,OAAAF,EAAUC,EAAOC,CAAK,EAEf,IACDD,EAAM,UAAYC,EAAM,QACnBA,EAAM,QAAQD,EAAM,SAAS,EAE7B,IAGb,CACF,CAAC,ECjFKgB,EAA2C,CAACC,EAAG,CAAE,MAAAhB,KAAY,OACjE,OAAOiB,EAAAjB,EAAM,UAAN,YAAAiB,EAAA,KAAAjB,EACT,EAEAkB,EAAeJ,kBAAgB,CAC7B,aAAc,CAAE,KAAM,CAAE,EACxB,KAAM,eACN,MAAO,CACL,SAAU,CAAE,KAAM,QAAS,QAAS,EAAM,EAC1C,KAAM,CAAE,KAAM,OAAQ,SAAU,EAAK,EACrC,UAAW,CAAE,KAAM,OAAQ,QAAS,KAAO,CAAI,EAAA,CACjD,EACA,MAAO,CAAC,QAAQ,EAChB,MAAMf,EAAO,CAAE,KAAAoB,EAAM,MAAAnB,GAAS,CAC5B,MAAMb,EAAWJ,IAEXqC,EAAaC,EAAA,SACjB,IAAM,CACJ,MAAMC,EAAanC,EAAS,oBAC1BY,EAAM,KACNA,EAAM,QAAA,EAEFwB,EAAcvB,EAAM,QACpBwB,EAAWF,EAAW,IAAKG,GAAMA,EAAE,QAAQ1B,EAAM,SAAS,CAAC,EAC3D2B,EAASH,EACXC,EAAS,QAASG,GAChBA,EAAM,OAASJ,EAAYI,CAAK,EAAI,CAAC,CAAA,EAEvCH,EAAS,KAAK,CAAC,EACZ,MAAA,CACL,OAAAE,EACA,SAAU,IAAMA,CAAA,CAEpB,CAAA,EAGFhB,OAAAA,EAAA,MACEU,EACA,CAAC,CAAE,OAAAM,CAAA,IAAa,CACR,MAAAE,EAAaF,EAAO,OAAS,EAC7BG,EAAU1C,EAAS,WAAW,IAAIY,EAAM,IAAI,EAC5C+B,EAAUD,EAAU,CAAC,GAAGA,EAAQ,KAAK,CAAC,EAAI,GAChDV,EAAK,SAAU,CAAE,WAAAS,EAAY,QAAAE,CAAS,CAAA,CACxC,EACA,CAAE,MAAO,MAAO,CAAA,EAEX,IAAM,OAEX,OADqBV,EAAW,MAAM,OAAO,OAEpC,CAGLW,EAAAA,EAAE,MAAO,CACP,MAAO,gBACP,IAAK,yCAAA,CACN,EAIDA,EAAAA,EAAEhB,EAAqBK,EAAW,MAAM,QAAQ,CAAA,GAG3CH,EAAAjB,EAAM,UAAN,YAAAiB,EAAA,KAAAjB,EACT,CAEJ,CACF,CAAC,ECjEe,SAAAgC,EAAeC,EAAa,GAAgB,CAC1D,MAAMX,EAA4BY,EAAAA,SAAa,IAAA,GAAK,EAEpD,SAASC,EAAKC,EAA2B,CACvC,GAAI,CAAC/C,EAAW,OAEhB,KAAM,CAAE,GAAAa,EAAI,KAAAC,EAAM,QAAA0B,EAAS,MAAAzB,EAAQ,GAAa,EAAAgC,EAChD,GAAI,CAAClC,GAAM,CAACC,GAAQ,CAAC0B,EAAS,OAEzBP,EAAW,IAAIpB,CAAE,GACpBoB,EAAW,IAAIpB,EAAQ,IAAA,GAAK,EAExB,MAAAmC,EAAsBf,EAAW,IAAIpB,CAAE,EAEvCoC,EAAe,CACnB,GAAApC,EACA,KAAAC,EACA,QAAA0B,EACA,MAAAzB,CAAA,EAGkBiC,EAAA,IAAIlC,EAAMmC,CAAY,CAC5C,CAEA,SAASC,EAAMH,EAA4B,CACnC,KAAA,CAAE,GAAAlC,EAAI,KAAAC,CAAS,EAAAiC,EACjB,GAAA,CAAClC,GAAM,CAACC,EAAM,OACZ,MAAAkC,EAAsBf,EAAW,IAAIpB,CAAE,EACzC,CAACmC,IAGLA,EAAoB,OAAOlC,CAAI,EAC1BkC,EAAoB,MACvBf,EAAW,OAAOpB,CAAE,EAExB,CAES,SAAAsC,EAAoBlC,EAAcmC,EAAqB,CACxD,MAAAJ,EAAsBf,EAAW,IAAIhB,CAAM,EACjD,GAAI,CAAC+B,EAAqB,MAAO,GAEjC,MAAMR,EAAU,MAAM,MAAKQ,GAAA,YAAAA,EAAqB,WAAY,CAAA,CAAE,EAE9D,OAAKI,EAKEnD,EACLuC,EACA,CAAClC,EAAcC,IAAiBD,EAAE,MAAQC,EAAE,KAAA,EALrC,CAACiC,EAAQ,IAAA,CAAK,CAOzB,CAEA,MAAM7C,EAAe,CACnB,KAAAmD,EACA,MAAAI,EACA,WAAAjB,EACA,oBAAAkB,CAAA,EAEK,OAAAP,EAAcS,EAAAA,SAAS1D,CAAE,EAAiBA,CACnD,CAEO,MAAMG,EAAW6C,EAAe,EC/DvB,SAAAW,EACdC,EACAC,EACA,CACA,MAAMC,EAAMC,EAAAA,UAAU,CAEpB,OAAQ,IAAMhB,EAAAA,EAAEb,EAAc0B,CAAW,CAAA,CAC1C,EAEG,GAAA,CAACA,EAAY,SAAU,CAGzB,MAAMI,EAEFC,EAAAA,qBAGA,UAAY,CAAA,EAChBH,EAAI,SAAS,SAAW,OAAO,OAAOE,CAAQ,CAEhD,CACAzC,EAAAA,UAAU,IAAM,CACduC,EAAI,MAAMD,CAAE,CAAA,CACb,EACDpC,EAAAA,gBAAgB,IAAM,CACpBqC,EAAI,QAAQ,CAAA,CACb,CACH,CCpBA,SAAwBI,EAAQJ,EAAUK,EAAyB,GAAI,CACrEA,EAAQ,aAAe,IACrBL,EAAI,UAAUK,EAAQ,YAAc,SAAUtC,CAAM,EACtDsC,EAAQ,mBAAqB,IAC3BL,EAAI,UAAUK,EAAQ,kBAAoB,eAAgBjC,CAAY,EAElE,MAAA/B,EAAWgE,EAAQ,UAAYC,EACjCN,EAAA,QAAQhE,EAAgBK,CAAQ,CACtC,CAEa,MAAAkE,EAAWD,EAEXE,EAAU"}